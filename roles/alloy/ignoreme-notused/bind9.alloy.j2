// =======================================================================================
// Bind9 DNS server logs collection configuration for Alloy
// Journal-only configuration (no log files)

// =======================================================================================
// Journal source for Bind9 logs
loki.relabel "bind9_journal" {
  forward_to = []
  
  rule {
    source_labels = ["__journal__systemd_unit"]
    regex = "named\\.service"
    action = "keep"
  }
  
  rule {
    source_labels = ["__journal_syslog_identifier"]
    target_label = "identifier"
  }
  
  rule {
    source_labels = ["__journal_priority_keyword"]
    target_label = "severity"
  }
  
  rule {
    target_label = "job"
    replacement = "bind9"
  }
  
  rule {
    source_labels = ["__journal__systemd_unit"]
    target_label  = "unit"
  }

  rule {
    source_labels = ["__journal__hostname"]
    target_label = "hostname"
  }

  rule {
    source_labels = ["__journal__transport"]
    target_label = "transport"
  }

}

// Journal processing pipeline for Bind9
loki.process "bind9_journal_logs" {
  forward_to    =  [{{ alloy_loki_endpoints | map(attribute='label') | map('regex_replace', '^(.*)$', 'loki.write.\\1.receiver') | join(', ') }}]
  
  // Set default log level
  stage.labels {
    values = {
      log_level = "info",
    }
  }
  
  // Override log level for warnings/errors
  stage.match {
    selector = "{severity=\"warning\"}"
    stage.labels {
      values = {
        log_level = "warning",
      }
    }
  }
  
  stage.match {
    selector = "{severity=\"error\"}"
    stage.labels {
      values = {
        log_level = "error",
      }
    }
  }
  
  // =======================================================================================
  // Zone operations
  stage.match {
    selector = "{job=\"bind9\"} |~ \"zone\""
    stage.regex {
      expression = "zone (?P<zone>[^/\\s:]+)"
    }
    stage.labels {
      values = {
        event_type = "zone_operation",
        zone = null,
      }
    }
  }
  
  // Zone loading events
  stage.match {
    selector = "{event_type=\"zone_operation\"} |~ \"loaded\""
    stage.labels {
      values = {
        zone_action = "loaded",
      }
    }
  }
  
  // Zone refresh events
  stage.match {
    selector = "{event_type=\"zone_operation\"} |~ \"refresh\""
    stage.labels {
      values = {
        zone_action = "refresh",
      }
    }
  }
  
  // DNSSEC signed zones
  stage.match {
    selector = "{event_type=\"zone_operation\"} |~ \"DNSSEC signed\""
    stage.labels {
      values = {
        zone_action = "dnssec_signed",
      }
    }
  }
  
  // =======================================================================================
  // Transfer operations
  stage.match {
    selector = "{job=\"bind9\"} |~ \"transfer of\""
    
    // Extract client, zone, and transfer type
    stage.regex {
      expression = "client [^\\s]+ (?P<client_ip>[^#]+)#(?P<client_port>\\d+)[^:]*: transfer of '(?P<zone>[^']+)': (?P<transfer_details>.*)"
    }
    
    stage.labels {
      values = {
        event_type = "transfer",
        client_ip = null,
        zone = null,
        transfer_details = null,
      }
    }
  }

  // Detect transfer types
  stage.match {
    selector = "{event_type=\"transfer\", transfer_details=~\".*AXFR.*\"}"
    stage.labels {
      values = {
        transfer_type = "AXFR",
      }
    }
  }

  stage.match {
    selector = "{event_type=\"transfer\", transfer_details=~\".*IXFR.*\"}"
    stage.labels {
      values = {
        transfer_type = "IXFR",
      }
    }
  }

  // Detect transfer status
  stage.match {
    selector = "{event_type=\"transfer\", transfer_details=~\".*started.*\"}"
    stage.labels {
      values = {
        transfer_status = "started",
      }
    }
  }

  stage.match {
    selector = "{event_type=\"transfer\", transfer_details=~\".*ended.*\"}"
    stage.labels {
      values = {
        transfer_status = "ended",
      }
    }
  }
  
  // =======================================================================================
  // Notify operations
  stage.match {
    selector = "{job=\"bind9\"} |~ \"received notify\""
    stage.regex {
      expression = "client [^\\s]+ (?P<client_ip>[^#]+)#(?P<client_port>\\d+): received notify for zone '(?P<zone>[^']+)'"
    }
    
    stage.labels {
      values = {
        event_type = "notify",
        notify_direction = "inbound",
        client_ip = null,
        zone = null,
      }
    }
  }
  
  stage.match {
    selector = "{job=\"bind9\"} |~ \"sending notifies\""
    stage.regex {
      expression = "zone (?P<zone>[^/\\s:]+).*sending notifies.*serial (?P<serial>\\d+)"
    }
    
    stage.labels {
      values = {
        event_type = "notify",
        notify_direction = "outbound",
        zone = null,
        serial = null,
      }
    }
  }
  
  // =======================================================================================
  // Query operations (if logged)
  stage.match {
    selector = "{job=\"bind9\"} |~ \"query\""
    stage.regex {
      expression = "client (?P<client_ip>[^#]+)#(?P<client_port>\\d+)[^:]*: query:.*(?P<query_domain>[a-zA-Z0-9.-]+) (?P<query_class>[^ ]+) (?P<query_type>[^ ]+)(?P<query_flags>.*)"
    }
    stage.labels {
      values = {
        event_type = "query",
        client_ip = null,
        query_domain = null,
        query_type = null,
      }
    }
  }
  
  // =======================================================================================
  // DNSSEC operations
  stage.match {
    selector = "{job=\"bind9\"} |~ \"DNSSEC|key|signing|verify\""
    stage.labels {
      values = {
        event_type = "dnssec",
      }
    }
  }
  
  // Managed keys
  stage.match {
    selector = "{job=\"bind9\"} |~ \"managed-keys-zone\""
    stage.regex {
      expression = "managed-keys-zone: Key (?P<key_id>\\d+) for zone (?P<zone>[^\\s]+) is now (?P<key_status>[^\\s]+)"
    }
    
    stage.labels {
      values = {
        event_type = "dnssec",
        dnssec_action = "managed_key",
        zone = null,
        key_id = null,
        key_status = null,
      }
    }
  }
  
  // =======================================================================================
  // Security events
  stage.match {
    selector = "{job=\"bind9\"} |~ \"denied|refused|TSIG|security\""
    stage.labels {
      values = {
        event_type = "security",
        alert_level = "medium",
      }
    }
  }
  
  // =======================================================================================
  // Server operations
  stage.match {
    selector = "{job=\"bind9\"} |~ \"starting|exiting|shutting down|running|reloading\""
    stage.labels {
      values = {
        event_type = "server_operation",
      }
    }
  }
  
  stage.match {
    selector = "{event_type=\"server_operation\"} |~ \"reloading configuration succeeded\""
    stage.labels {
      values = {
        server_action = "config_reload",
        status = "success",
      }
    }
  }
  
  stage.match {
    selector = "{event_type=\"server_operation\"} |~ \"running\""
    stage.labels {
      values = {
        server_action = "started",
        status = "running",
      }
    }
  }
  
  // =======================================================================================
  // Configuration issues
  stage.match {
    selector = "{job=\"bind9\"} |~ \"has no address records\""
    stage.regex {
      expression = "zone ([^/]+)/IN: ([^']+)'([^']+)' has no address records"
    }
    stage.labels {
      values = {
        event_type = "config_warning",
        warning_type = "missing_address_records",
        alert_level = "low",
      }
    }
  }
  
  // =======================================================================================
  // Drop noisy automatic empty zone messages
  stage.match {
    selector = "{job=\"bind9\"} |~ \"automatic empty zone\""
    action = "drop"
  }
  
  // Clean up labels to reduce cardinality
  stage.label_drop {
    values = ["client_port", "transfer_details", "query_flags"]
  }
}

// Add journal source to collect Bind9 logs from systemd
loki.source.journal "bind9_journal_source" {
  relabel_rules = loki.relabel.bind9_journal.rules
  forward_to = [loki.process.bind9_journal_logs.receiver]
  max_age = "12h"
  labels = {component = "loki.source.journal.bind9"}
}
