// =======================================================================================
// =======================================================================================
// Postfix and Dovecot logs collection configuration for Alloy

// =======================================================================================
// Define file match patterns for mail logs
local.file_match "mail_logs" {
  path_targets = [{
    __address__ = "localhost",
    __path__    = "/var/log/mail.log",
    host        = "{{ ansible_hostname }}",
    job         = "mail",
    label       = "mail_combined",
  }]
}

// =======================================================================================
// Process pipeline for mail logs
loki.process "mail_logs" {
  forward_to    =  [{{ alloy_loki_endpoints | map(attribute='label') | map('regex_replace', '^(.*)$', 'loki.write.\\1.receiver') | join(', ') }}]

  // Simplified mail log format parsing - reduced escaping
  stage.regex {
    expression = "^(?P<timestamp>\\w+ +\\d+ \\d+:\\d+:\\d+) (?P<hostname>\\S+) (?P<service>[^\\[]+)\\[(?P<pid>\\d+)\\](?::? (?P<queue_id>[A-F0-9]+):?)? (?P<message>.*)"
  }
  
  stage.timestamp {
    source = "timestamp"
    format = "Jan _2 15:04:05"
  }
  
  stage.labels {
    values = {
      service = null,
      pid     = null,
      queue_id = null,
    }
  }
  
  // Identify mail service type
  stage.match {
    selector = "{service=~\"postfix\"}"
    stage.labels {
      values = {
        mail_service = "postfix",
      }
    }
  }
  
  stage.match {
    selector = "{service=~\"dovecot\"}"
    stage.labels {
      values = {
        mail_service = "dovecot",
      }
    }
  }
  
  // =======================================================================================
  // Postfix-specific log parsing
  
  // Extract SMTP transaction details - simplified pattern
  stage.match {
    selector = "{mail_service=\"postfix\", message=~\"status=\"}"
    stage.regex {
      expression = "(?P<client_info>[^,]*), status=(?P<status>\\S+)"
    }
  }
  
  // Track delivery statuses
  stage.match {
    selector = "{status=\"sent\"}"
    stage.labels {
      values = {
        delivery_result = "success",
      }
    }
  }
  
  stage.match {
    selector = "{status=\"bounced\"}"
    stage.labels {
      values = {
        delivery_result = "bounce",
      }
    }
  }
  
  stage.match {
    selector = "{status=\"deferred\"}"
    stage.labels {
      values = {
        delivery_result = "deferred",
      }
    }
  }
  
  stage.match {
    selector = "{status=\"rejected\"}"
    stage.labels {
      values = {
        delivery_result = "rejected",
      }
    }
  }
  
  // SMTP authentication events - simplified
  stage.match {
    selector = "{mail_service=\"postfix\", message=~\"sasl_method\"}"
    stage.regex {
      expression = "sasl_method=(?P<auth_method>\\S+), sasl_username=(?P<auth_user>\\S+)"
    }
    
    stage.labels {
      values = {
        event_type = "smtp_auth",
      }
    }
  }
  
  // Extract email sender/recipient - simplified
  stage.match {
    selector = "{mail_service=\"postfix\", message=~\"from=<\"}"
    stage.regex {
      expression = "from=<(?P<sender>[^>]*)>"
    }
  }
  
  stage.match {
    selector = "{mail_service=\"postfix\", message=~\"to=<\"}"
    stage.regex {
      expression = "to=<(?P<recipient>[^>]*)>"
    }
    
    stage.labels {
      values = {
        event_type = "mail_delivery",
      }
    }
  }
  
  // Identify message size
  stage.match {
    selector = "{mail_service=\"postfix\", message=~\"size=\"}"
    stage.regex {
      expression = "size=(?P<message_size>\\d+)"
    }
  }
  
  // SPAM/virus filter results - simplified
  stage.match {
    selector = "{mail_service=\"postfix\", message=~\"SPAM\"}"
    stage.labels {
      values = {
        spam_detected = "true",
      }
    }
  }
  
  stage.match {
    selector = "{mail_service=\"postfix\", message=~\"VIRUS|INFECTED\"}"
    stage.labels {
      values = {
        virus_detected = "true",
      }
    }
  }
  
  // =======================================================================================
  // Dovecot-specific log parsing
  
  // IMAP/POP3 logins - simplified
  stage.match {
    selector = "{mail_service=\"dovecot\", message=~\"Login:\"}"
    stage.regex {
      expression = "Login: user=<(?P<login_user>[^>]*)>"
    }
    
    stage.labels {
      values = {
        event_type = "mail_login",
      }
    }
  }
  
  // Failed logins
  stage.match {
    selector = "{mail_service=\"dovecot\", message=~\"auth failed\"}"
    stage.labels {
      values = {
        event_type = "mail_auth_failure",
      }
    }
  }
  
  // Mailbox operations
  stage.match {
    selector = "{mail_service=\"dovecot\", message=~\"[Mm]ailbox\"}"
    stage.labels {
      values = {
        event_type = "mailbox_operation",
      }
    }
  }
  
  // Disconnections - simplified
  stage.match {
    selector = "{mail_service=\"dovecot\", message=~\"Disconnected\"}"
    stage.labels {
      values = {
        event_type = "mail_disconnect",
      }
    }
  }
  
  // Security events - simplified
  stage.match {
    selector = "{message=~\"blacklist|blocked\", mail_service=\"postfix\"}"
    stage.labels {
      values = {
        security_event = "blocked_sender",
      }
    }
  }
  
  // Track TLS connections
  stage.match {
    selector = "{message=~\"TLS connection\"}"
    stage.labels {
      values = {
        tls_connection = "true",
      }
    }
  }
  
  // Clean up labels to reduce cardinality
  stage.label_drop {
    values = ["pid", "hostname"]
  }
}

// =======================================================================================
// Source definitions to read the mail log files
loki.source.file "mail_logs" {
  targets               = local.file_match.mail_logs.targets
  forward_to            = [loki.process.mail_logs.receiver]
  legacy_positions_file = "/tmp/positions.yaml"
}
